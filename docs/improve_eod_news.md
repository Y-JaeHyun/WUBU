# EOD 뉴스/공시 개선 작업 기록

## 작업 일자
2026-02-28

## 변경 내용

### 1. `format_eod_news()` 전면 개선 (src/data/news_collector.py)

**기존 문제점:**
- 보유종목 공시와 기타 공시만 2단 분류
- 감성 분류(classify_sentiment)가 이미 구현되어 있으나 EOD 뉴스에서 미사용
- 전략 시그널 상위 종목(관심종목)의 공시를 별도로 표시하지 않음

**개선 사항:**
- **3단 분류**: 보유종목 > 관심종목(watchlist) > 기타 순 우선 표시
- **감성 분류 아이콘/라벨 통합**: 각 공시에 `[+]`, `[-]`, `[=]` 아이콘 + 한글 라벨(상승요인/하락요인/중립)
- **감성 요약 통계**: 상단에 전체 공시의 감성 분포 표시 (`총 N건 ([+]X [-]Y [=]Z)`)
- **watchlist 파라미터 추가**: 전략 시그널 상위 종목을 관심종목으로 전달 가능
- **중복 방지**: watchlist에서 holdings를 자동 제외

**신규 헬퍼 메서드:**
- `_format_disc_with_sentiment(disc, tag)`: 개별 공시를 감성 아이콘 + 태그 포함 1줄로 포매팅

### 2. 스케줄러 `eod_news_summary()` 개선 (src/scheduler/main.py)

**기존 문제점:**
- `get_balance()`의 raw holdings (list of dict)를 그대로 `format_eod_news()`에 전달
  - holdings = `[{"ticker": "005930", "name": "삼성전자", ...}]` 형태
  - 하지만 `format_eod_news()`는 stock_code 문자열 리스트를 기대

**개선 사항:**
- holdings에서 ticker 문자열만 추출하여 전달
- `_collect_eod_watchlist()` 메서드 신규 추가: 당일 전략 시그널 상위 종목을 관심종목으로 수집
- 시그널 캐시 (`_last_long_signals`, `_last_etf_signals`) 추가: 08:50/09:05에 생성된 시그널을 15:40 EOD 뉴스에서 재활용

### 3. 시그널 캐시 인프라 (src/scheduler/main.py)

- `__init__`에 `_last_long_signals`, `_last_etf_signals` 딕셔너리 초기화
- 장전 시그널 체크(08:50)와 리밸런싱 실행(09:05) 시점에 시그널을 캐시
- `_collect_eod_watchlist()`: 캐시된 시그널의 상위 20종목 + ETF 시그널 종목을 관심종목으로 반환

---

## 감성 분류 키워드 사전

### 긍정(positive) - 주가 상승 요인
| 카테고리 | 키워드 |
|----------|--------|
| 실적 호전 | 실적호전, 실적개선, 매출증가, 영업이익증가, 흑자전환, 흑자, 실적 호전 |
| 주주환원 | 자기주식취득, 자사주매입, 자사주취득, 자기주식소각, 배당, 현금ㆍ현물배당, 중간배당, 무상증자 |
| 사업 확장 | 신규사업, 신규투자, 시설투자, 해외진출, 수주, 계약체결, 공급계약, 특허취득, 기술이전 |
| 지분 매수 | 주식등의대량보유상황보고서 (5% 이상 매수 신고) |

### 부정(negative) - 주가 하락 요인
| 카테고리 | 키워드 |
|----------|--------|
| 실적 악화 | 실적악화, 매출감소, 영업이익감소, 영업손실, 적자전환, 적자, 적자지속 |
| 가치 희석 | 유상증자, 전환사채, 신주인수권부사채, 주식매수선택권부여 |
| 리스크 | 상장폐지, 관리종목, 투자주의, 불성실공시, 횡령, 배임, 소송, 과징금, 행정처분 |
| 감사 이슈 | 감사의견거절, 감사의견한정, 감사범위제한 |
| 지분 매도 | 최대주주변경, 대주주지분매도 |
| 불확실성 | 영업양수도, 분할 |

### 중립(neutral) - 정보 참고
| 카테고리 | 키워드 |
|----------|--------|
| 정기 보고 | 사업보고서, 분기보고서, 반기보고서 |
| 경영 변동 | 임원ㆍ주요주주, 대표이사변경, 감사변경, 정관변경, 주주총회 |
| 기타 | 타법인주식, 투자판단, 합병등종료, 합병보고 |

### 카테고리 기본 감성 (키워드 미매칭 시 fallback)
| 카테고리 | 기본 감성 | 이유 |
|----------|----------|------|
| earnings | neutral | 실적은 내용에 따라 다름 |
| rights_issue | negative | 유상증자 = 희석 |
| buyback | positive | 자사주 매입 = 주주환원 |
| major_shareholder | neutral | 대주주 변동 = 양면성 |
| merger | neutral | 합병 = 양면성 |
| dividend | positive | 배당 = 주주환원 |
| delisting | negative | 상장폐지 = 위험 |
| investment | neutral | 투자판단 = 내용에 따라 |

### 판단 우선순위
- negative 키워드를 먼저 체크 (보수적 판단)
- 예: "유상증자 후 배당 결정" -> 유상증자(부정)로 분류

---

## 알림 포맷 예시

### 개선 전
```
[장마감 공시] 2026-02-28
------------------------------

[보유종목 관련] 1건
  * 삼성전자: 영업(잠정)실적(공정공시)

[기타 주요 공시] 2건
  - SK하이닉스: 자기주식취득결정
  - 네이버: 합병등종료보고서
```

### 개선 후
```
[장마감 공시] 2026-02-28
------------------------------
총 3건 ([+]1 [-]0 [=]2)

[보유종목 관련] 1건
  [=][보유] 삼성전자: 영업(잠정)실적(공정공시) (~중립)

[관심종목 관련] 1건
  [+][관심] SK하이닉스: 자기주식취득결정 (+상승요인)

[기타 주요 공시] 1건
  [=] 네이버: 합병등종료보고서 (~중립)
```

### 포맷 설명
- `[+]` / `[-]` / `[=]`: 감성 분류 아이콘 (긍정/부정/중립)
- `[보유]` / `[관심]`: 포트폴리오 연관 태그
- `(+상승요인)` / `(-하락요인)` / `(~중립)`: 한글 감성 라벨
- 상단 요약: 전체 건수 + 감성별 분포

---

## 테스트 현황
- 기존 테스트: 41개 (변경 없이 통과)
- 신규 테스트: 28개 추가 (총 69개)
  - TestFormatEodNews: +8개 (감성 아이콘, 라벨, 요약 통계, 관심종목, 태그 등)
  - TestClassifySentiment: 11개 (긍정/부정/중립/폴백/우선순위)
  - TestSentimentHelpers: 8개 (아이콘/라벨 변환)
  - TestFormatDiscWithSentiment: 5개 (개별 공시 포매팅)

## 변경 파일
- `src/data/news_collector.py`: format_eod_news() 개선 + _format_disc_with_sentiment() 추가
- `src/scheduler/main.py`: eod_news_summary() 개선 + _collect_eod_watchlist() + 시그널 캐시
- `tests/test_news_collector.py`: 28개 테스트 추가
