# Phase 5 기획서: 24시간 지능형 트레이딩 시스템

> 작성일: 2026-02-19
> 상태: 기획 완료, 구현 대기

---

## 1. 현재 시스템 현황

### 운영 중인 기능
| 항목 | 상태 |
|------|------|
| 전략 | MultiFactor(value+momentum, zscore, top10+MT) |
| 실행 | KIS OpenAPI 실전투자 (주문 차단: KIS_LIVE_CONFIRMED=false) |
| 알림 | Telegram (모닝/헬스체크/모니터링/EOD/이브닝) |
| 스케줄 | 7개 작업 (07:00~19:00), 월~금만 |
| 테스트 | 375 passed |
| 계좌 | 소규모 자본, ETF 보유 |

### 현재 스케줄 (07:00~19:00만 활용)
```
07:00  모닝 브리핑
08:00  헬스 체크
08:50  장 전 시그널 체크
09:05  리밸런싱 실행
09~15  매시 포트폴리오 모니터링
15:35  EOD 리뷰
19:00  이브닝 리포트
── 19:00 이후 ~ 07:00 → 대기 (아무것도 안 함) ──
```

### 핵심 문제
1. **시스템 가동율 50%**: 하루 12시간(19:00~07:00) + 주말 완전 유휴
2. **학습 능력 없음**: 전략 고정, 시장 변화 무대응
3. **글로벌 시장 사각지대**: 미국 장 등 해외 동향 정보 없음

---

## 2. 요구사항 및 개선안

---

### 2.1 요구사항 1: 24시간 활용

#### Phase 5-A1: 야간 글로벌 시장 모니터

| 항목 | 내용 |
|------|------|
| **What** | 미국 주요 지수(S&P500, NASDAQ, 다우), 환율(USD/KRW), VIX 등을 FinanceDataReader로 수집하여 텔레그램으로 요약 발송 |
| **Why** | 미국 시장이 다음날 한국 시장에 직접 영향. 현재 글로벌 데이터 수집 전무 |
| **난이도** | 하 |
| **우선순위** | P0 |

**신규 파일**: `src/data/global_collector.py`
**스케줄 추가**: 22:30(미국 장 개장), 01:00(중간 점검), 05:30(마감 요약)

#### Phase 5-A2: 야간 리서치 엔진

| 항목 | 내용 |
|------|------|
| **What** | 장 마감 후(16:00~) 자동 백테스트, 종목 리뷰, 섹터 분석을 실행하고 결과를 06:30 사전 브리핑에 종합 발송 |
| **Why** | 장 중에는 모니터링에 집중하고, 리서치는 야간에 자동 수행 |
| **난이도** | 중 |
| **우선순위** | P0 |

**신규 파일**: `src/scheduler/night_research.py`
**스케줄 추가**: 16:00(자동 백테스트), 17:00(종목 리뷰), 20:00(섹터 분석), 06:30(사전 브리핑)

#### Phase 5-A3: 주말 대규모 리서치

| 항목 | 내용 |
|------|------|
| **What** | 토요일: ML 재학습 + 대규모 백테스트 + 유니버스 스캔. 일요일: 차주 이벤트 정리 + 전략 브리핑 |
| **Why** | 주말은 API 부하가 적고 대규모 연산에 최적 |
| **난이도** | 중 |
| **우선순위** | P1 |

**신규 파일**: `src/scheduler/weekend_research.py`

---

### 2.2 요구사항 2: 학습하는 시스템

#### Phase 5-B1: 관심 종목 자동 리뷰

| 항목 | 내용 |
|------|------|
| **What** | 보유 종목 + 차기 리밸런싱 후보 종목에 대해 다면적 리뷰 수행. 펀더멘탈 변화(PBR/PER 추이), 거래량 이상, DART 공시, 모멘텀 추이 종합 |
| **Why** | 현재 `hourly_monitor()`는 가격 변동(5%↑)만 감지. 종합적 종목 분석 부재 |
| **난이도** | 중 |
| **우선순위** | P0 |

**신규 파일**: `src/report/stock_reviewer.py`
**기존 모듈 활용**: `collector.get_fundamental()`, `collector.get_price_data()`, `dart_collector.get_financial_statements()`, `kis_client.get_balance()`

```python
class StockReviewer:
    def review_holdings(self, holdings: list[dict]) -> list[dict]:
        """보유 종목 리뷰 (모멘텀 변화, 거래량 급변, 공시, PBR/PER)"""
    def review_candidates(self, strategy_signals: dict) -> list[dict]:
        """차기 리밸런싱 후보 리뷰 (팩터 스코어, 유동성)"""
    def format_review_telegram(self, reviews: list[dict]) -> str:
        """텔레그램 발송용 포맷"""
```

#### Phase 5-B2: 전략 성과 피드백 루프

| 항목 | 내용 |
|------|------|
| **What** | EOD에 전략 수익률 vs KOSPI 비교, 7/30/90일 롤링 초과수익률 계산, 언더퍼폼 지속 시 파라미터 최적화 제안 |
| **Why** | `UnderperformCondition`이 구현되어 있으나 단순 알림만. 피드백 루프를 완성하면 전략이 시장에 자동 적응 |
| **난이도** | 중 |
| **우선순위** | P1 |

**신규 파일**: `src/report/strategy_feedback.py`
**수정 파일**: `src/scheduler/main.py` (eod_review 강화)

#### Phase 5-B3: DART 공시/뉴스 수집기

| 항목 | 내용 |
|------|------|
| **What** | DART 공시 검색 API로 보유/관심 종목의 최근 공시 수집. 중요 공시(실적, 증자, 대주주변경) 필터링 → 텔레그램 알림 |
| **Why** | 주가에 가장 큰 영향을 미치는 공시 정보가 현재 미수집. DART API 키 보유 중 |
| **난이도** | 중 |
| **우선순위** | P1 |

**신규 파일**: `src/data/news_collector.py`
**기존 연동**: `dart_collector.py`의 OpenDartReader 연결 공유

#### Phase 5-B4: ML 모델 자동 재학습

| 항목 | 내용 |
|------|------|
| **What** | 주 1회(토 04:00) ML 팩터 모델을 최신 데이터로 재학습. IC/Rank IC 개선 시 자동 교체 + 알림 |
| **Why** | `MLPipeline`이 Ridge/RF/GBR 지원하나 스케줄러에 미통합. 시장 레짐 변화 시 팩터 유효성 변화에 대응 필요 |
| **난이도** | 상 |
| **우선순위** | P1 |

**신규 파일**: `src/scheduler/ml_retrain.py`
**기존 활용**: `ml/pipeline.py`의 `train()`, `predict()`, `ml/features.py`의 `build_factor_features()`

#### Phase 5-B5: 자동 백테스트 스위트

| 항목 | 내용 |
|------|------|
| **What** | 장 마감 후 현재 운영 전략 + 파라미터 변형 15개 조합을 자동 백테스트. 최고 성과 파라미터를 다음 리밸런싱에 제안 |
| **Why** | 시장 레짐 변화에 전략 파라미터가 최적 상태인지 주기적 검증 필요 |
| **난이도** | 중 |
| **우선순위** | P0 |

**신규 파일**: `src/scheduler/auto_backtest.py`
**기존 활용**: `backtest/engine.py`, `scripts/run_backtest.py` 로직 재활용

---

### 2.3 요구사항 3: 시스템 개선

#### Phase 5-C1: 데이터 캐싱 레이어

| 항목 | 내용 |
|------|------|
| **What** | pykrx/DART API 호출 결과를 2계층(메모리+디스크) 캐싱. parquet 포맷으로 저장 |
| **Why** | 24시간 운영 + 자동 백테스트 시 API 호출량 폭증. `get_all_fundamentals()` 호출당 수십 초 소요 |
| **난이도** | 중 |
| **우선순위** | P0 |

**신규 파일**: `src/data/cache.py`
**수정 파일**: `src/data/collector.py` (캐시 래퍼 통합)
**추가 패키지**: `pyarrow` (parquet I/O)

#### Phase 5-C2: 손절/이익실현 룰

| 항목 | 내용 |
|------|------|
| **What** | 개별 종목 손절(-10%) 이익실현(+30%) 규칙. 리밸런싱 주기와 무관하게 hourly_monitor에서 즉시 실행 |
| **Why** | 월 1회 리밸런싱 사이 30영업일 동안 급락 대응 불가 |
| **난이도** | 중 |
| **우선순위** | P1 |

**신규 파일**: `src/execution/stop_loss.py`
**수정 파일**: `src/scheduler/main.py` (hourly_monitor에 통합)

#### Phase 5-C3: 포트폴리오 성과 DB (SQLite)

| 항목 | 내용 |
|------|------|
| **What** | 일별 포트폴리오 가치, 수익률, MDD, 벤치마크 대비 초과수익률을 SQLite DB에 저장 |
| **Why** | 현재 `PortfolioTracker`는 JSON에 최대 500건만 보관 (~2개월). 장기 성과 분석 불가 |
| **난이도** | 중 |
| **우선순위** | P1 |

**신규 파일**: `src/data/performance_db.py`

#### Phase 5-C4: 섹터 분석 모듈

| 항목 | 내용 |
|------|------|
| **What** | 업종별 성과 추적, 섹터 로테이션 감지, 포트폴리오 섹터 편중도 모니터링 |
| **Why** | 전략이 섹터 중립이 아니어서 특정 업종 과집중 리스크 존재 |
| **난이도** | 중 |
| **우선순위** | P2 |

**신규 파일**: `src/report/sector_analyzer.py`

#### Phase 5-C5: 멀티 전략 동시 추적

| 항목 | 내용 |
|------|------|
| **What** | 여러 전략을 가상 포트폴리오로 동시 추적. 실매매는 1개, 나머지 페이퍼 트래킹. 성과 비교 |
| **Why** | 전략 1개만 고정 운영 → 시장 환경별 동적 전환 불가 |
| **난이도** | 상 |
| **우선순위** | P2 |

**신규 파일**: `src/scheduler/multi_strategy.py`
**추적 대상**: MultiFactor, DualMomentum, Value, RiskParity, MLFactor (모두 구현 완료)

#### Phase 5-C6: 텔레그램 인터랙티브 커맨드

| 항목 | 내용 |
|------|------|
| **What** | `/status`, `/portfolio`, `/scan`, `/signal`, `/mdd` 등 텔레그램 커맨드로 실시간 조회 |
| **Why** | 현재 단방향 알림만 가능. 이동 중에도 시스템 조회/제어 필요 |
| **난이도** | 상 |
| **우선순위** | P2 |

**신규 파일**: `src/alert/telegram_commands.py`
**추가 패키지**: `python-telegram-bot>=20.0`

#### Phase 5-C7: 전략 의사결정 로깅

| 항목 | 내용 |
|------|------|
| **What** | 리밸런싱마다 팩터 스코어, 랭킹, 필터링 결과를 구조화하여 JSON 저장 |
| **Why** | 전략 결과만 출력, 중간 과정 추적 불가 |
| **난이도** | 하 |
| **우선순위** | P2 |

**신규 파일**: `src/report/strategy_logger.py`

---

## 3. Phase별 로드맵

### Phase 5-A: 즉시 실행 — "시스템을 깨우자"

| # | 개선안 | 우선순위 | 난이도 | 핵심 파일 |
|---|--------|----------|--------|-----------|
| A1 | 데이터 캐싱 레이어 (C1) | P0 | 중 | `data/cache.py` |
| A2 | 글로벌 시장 모니터 (A1) | P0 | 하 | `data/global_collector.py` |
| A3 | 관심 종목 자동 리뷰 (B1) | P0 | 중 | `report/stock_reviewer.py` |
| A4 | 자동 백테스트 스위트 (B5) | P0 | 중 | `scheduler/auto_backtest.py` |
| A5 | 야간 리서치 엔진 (A2) | P0 | 중 | `scheduler/night_research.py` |

**완료 시 기대효과**:
- 시스템 가동율: 50% → 92% (22h/24h)
- 텔레그램 알림: 일 7건 → 15~20건
- pykrx API 호출량 70% 감소 (캐싱)

### Phase 5-B: 학습 자동화 — "스스로 배우자"

| # | 개선안 | 우선순위 | 난이도 | 핵심 파일 |
|---|--------|----------|--------|-----------|
| B1 | 전략 성과 피드백 루프 (B2) | P1 | 중 | `report/strategy_feedback.py` |
| B2 | DART 공시/뉴스 수집 (B3) | P1 | 중 | `data/news_collector.py` |
| B3 | 손절/이익실현 룰 (C2) | P1 | 중 | `execution/stop_loss.py` |
| B4 | 포트폴리오 성과 DB (C3) | P1 | 중 | `data/performance_db.py` |
| B5 | ML 모델 자동 재학습 (B4) | P1 | 상 | `scheduler/ml_retrain.py` |
| B6 | 주말 대규모 리서치 (A3) | P1 | 중 | `scheduler/weekend_research.py` |

**완료 시 기대효과**:
- 자기 학습 루프 완성: 전략→성과→피드백→개선
- 공시 기반 리스크 조기 감지
- 급변 시 비상 매도 가능

### Phase 5-C: 고도화 — "더 똑똑해지자"

| # | 개선안 | 우선순위 | 난이도 | 핵심 파일 |
|---|--------|----------|--------|-----------|
| C1 | 섹터 분석 (C4) | P2 | 중 | `report/sector_analyzer.py` |
| C2 | 전략 의사결정 로깅 (C7) | P2 | 하 | `report/strategy_logger.py` |
| C3 | 멀티 전략 동시 추적 (C5) | P2 | 상 | `scheduler/multi_strategy.py` |
| C4 | 텔레그램 인터랙티브 (C6) | P2 | 상 | `alert/telegram_commands.py` |

---

## 4. 24시간 스케줄 구체안

### 4.1 주중 거래일 (월~금)

```
시간      작업                              유형       기존/신규
──────────────────────────────────────────────────────────────
00:00     (대기)
01:00     미국 장 중간 점검                  야간       신규
04:00     야간 배치 (캐시 갱신)              배치       신규
05:30     미국 장 마감 최종 요약              야간       신규
06:30     당일 사전 브리핑 (야간 요약 종합)    야간       신규
──────────────────────────────────────────────────────────────
07:00     모닝 브리핑 + 글로벌 야간 요약      주간       기존(강화)
08:00     헬스 체크                          주간       기존
08:50     장 전 시그널 체크                   주간       기존
09:05     리밸런싱 실행 (월 1회)              주간       기존
09~15     매시 모니터링 + 손절 체크            주간       기존(강화)
──────────────────────────────────────────────────────────────
15:35     EOD 리뷰 + 벤치마크 비교            장마감후    기존(강화)
16:00     자동 백테스트 (현재 전략 검증)       장마감후    신규
17:00     관심 종목 자동 리뷰                 장마감후    신규
19:00     이브닝 리포트                       장마감후    기존
──────────────────────────────────────────────────────────────
20:00     섹터별 성과 분석                    야간       신규
21:00     DART 공시/뉴스 체크                 야간       신규
22:30     미국 장 개장 모니터링               야간       신규
23:00     미국 시장 1차 요약                  야간       신규
──────────────────────────────────────────────────────────────
```

### 4.2 주말 (토/일)

```
시간      작업                              유형
──────────────────────────────────────────────────────────────
[토요일]
04:00     ML 모델 재학습 (3개 모델)           배치
06:00     대규모 백테스트 (15개 조합)          배치
10:00     전체 유니버스 스캔 (2000+ 종목)      리서치
14:00     주간 종합 리포트 생성 및 발송         리포트
──────────────────────────────────────────────────────────────
[일요일]
10:00     차주 이벤트 캘린더 정리              리서치
18:00     차주 전략 브리핑 발송                리포트
──────────────────────────────────────────────────────────────
```

---

## 5. 신규 파일 목록

```
src/
├── data/
│   ├── global_collector.py       # [A1] 글로벌 시장 데이터
│   ├── news_collector.py         # [B3] DART 공시/뉴스
│   └── cache.py                  # [C1] 데이터 캐싱
│   └── performance_db.py         # [C3] SQLite 성과 DB
├── report/
│   ├── stock_reviewer.py         # [B1] 종목 자동 리뷰
│   ├── strategy_feedback.py      # [B2] 전략 피드백 루프
│   ├── sector_analyzer.py        # [C4] 섹터 분석
│   └── strategy_logger.py        # [C7] 전략 의사결정 로깅
├── execution/
│   └── stop_loss.py              # [C2] 손절/이익실현
├── scheduler/
│   ├── night_research.py         # [A2] 야간 리서치 엔진
│   ├── auto_backtest.py          # [B5] 자동 백테스트
│   ├── weekend_research.py       # [A3] 주말 리서치
│   ├── ml_retrain.py             # [B4] ML 자동 재학습
│   └── multi_strategy.py         # [C5] 멀티 전략 추적
└── alert/
    └── telegram_commands.py      # [C6] 텔레그램 인터랙티브
```

---

## 6. 구현 시 주의사항

### 6.1 API Rate Limit
| API | 제한 | 대응 |
|-----|------|------|
| pykrx | 초당 5회 이하 권장 | 캐싱 레이어 최우선 구현 |
| DART | 일 10,000회 | 1시간 단위 조회, 캐시 |
| KIS | 초당 20회, 토큰 분당 1회 | 기존 RATE_LIMIT_DELAY 유지 |
| FinanceDataReader | 비공식 | 30분 간격 제한 |

### 6.2 KIS 새벽 점검 (01:00~05:00)
- 새벽 배치: KIS API 사용하지 않는 작업만 (pykrx, ML)
- KIS 필요 작업: 06:30 이후 배치

### 6.3 텔레그램 알림 과다 방지
- DND 시간대(23:00~07:00): INFO 알림 억제, 06:30 사전 브리핑에 일괄
- CRITICAL은 항상 즉시 발송
- 기존 AlertManager 쿨다운 메커니즘 활용

### 6.4 pandas 3.x 호환성
- `apply()` + mock 비호환 → `list comprehension` 사용
- 신규 모듈에도 동일 원칙 적용

### 6.5 환경변수 추가
```bash
# Phase 5-A
GLOBAL_MARKET_ENABLED=true
NIGHT_RESEARCH_ENABLED=true
AUTO_BACKTEST_ENABLED=true

# Phase 5-B
NEWS_COLLECTOR_ENABLED=true
ML_RETRAIN_ENABLED=true
STOP_LOSS_PCT=-0.10
TAKE_PROFIT_PCT=0.30

# Phase 5-C
TELEGRAM_COMMANDS_ENABLED=false
```

---

## 7. KPI

| 지표 | 현재 | 5-A 목표 | 5-C 목표 |
|------|------|----------|----------|
| 시스템 가동율 | 50% | 92% | 95%+ |
| 일일 알림 | 7건 | 15~20건 | 20~25건 |
| pykrx API 호출 | 높음 | -70% | -80% |
| 성과 추적 기간 | ~2개월 | 무제한 | 무제한 |
| ML 갱신 주기 | 없음 | 주 1회 | 주 1회 |
| 글로벌 인사이트 | 없음 | 일 4~5건 | 일 5~6건 |
